<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>commander</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<style>
			#photo{
				float:right;
				width:512px;
				height:256px;
				border:1px solid black;
			}
			#map{
				border:1px solid black;
			}
		</style>
	</head>
	<body class="disconnected">
		<form method="post">
			<a id="photo-link" target="_blank"><img id="photo" alt="no image"></a>
			<fieldset>
				<legend>motor controls</legend>
				<button type="submit" name="do" value="stop">stop</button>
				<br>
				<button type="submit" name="do" value="backward">backward</button>
				<button type="submit" name="do" value="forward">forward</button>
				<br>
				<button type="submit" name="do" value="left">left</button>
				<button type="submit" name="do" value="right">right</button>
			</fieldset>
			<fieldset>
				<legend>high-level controls</legend>
				<button type="submit" name="go" value="photo">take a photo</button>
			</fieldset>
			<fieldset>
				<legend>sensors</legend>
				<label for="battery">battery</label>
				<input id="battery">
			</fieldset>
			<fieldset>
				<legend>map</legend>
				<canvas id="map" width="800" height="800">
					cannot show map
				</canvas>
			</fieldset>
		</form>
		<script>
			$(function(){
				function fillCircle(gfx,pos,r,c){
					var oldc = gfx.fillStyle;
					gfx.fillStyle=c;
					gfx.arc(pos[0],pos[1],r,0,2*Math.PI);
					gfx.fill();
					gfx.fillStyle = oldc;
					gfx.beginPath();
				}
				function fillTile(gfx,pos,r,c){
					var oldc=gfx.fillStyle;
					gfx.fillStyle=c;
					gfx.rect(pos[0],pos[1],r,r);
					gfx.fill();
					gfx.fillStyle = oldc;
					gfx.beginPath();
				
				}
				function updateMap(position,pTrail,trail,obstacles){
					var c=document.getElementById("map");
					var gr=c.getContext("2d");
					
					var gridres=8;
					
					console.log(1.23);
					var cp = "#0000FF";
					var pp = "#00AA00";
					var fp = "#D07000";
					var op = "#000000"; //don't change this colour
					
					//position=[x,y] in meters: position[0]=x, position[1]=y
					//pTrail=[[left_arclength,right_arclength],...]
					//trail=[[left_arclength,right_arclength],...]
					//0<=obstacles[i][j]<=1
					
					pos=[400,400]
					pTrail=[[429,429],[444,429],[460,481]]
					trail=[[380,380]]
					
					//obstacles=[[1,1,1,1],[0,0.5,0,1],[0.7,0.6,0.5,0.4],[0.1,0.2,0.4,0.8]]
					obstacles = [];
					var gridSize=800/gridres|0;
					for (var i=0;i< gridSize; i++){
						obstacles[i]=[];
						for (var j=0;j<gridSize; j++){
							obstacles[i][j]=Math.random();
						
						}
					
					}
					
					for (var i=0;i< obstacles.length ;i++){ 
						for (var j = 0; j < obstacles[i].length;j++){
							var hex=(255-(256*obstacles[i][j]|0)).toString(16);
							while(hex.length<2)
								hex="0"+hex;
							fillTile(gr, [j*gridres, i*gridres], gridres, "#"+hex+hex+hex);
						}
					}
					
					for (var i=0;i<pTrail.length;i++){ 
						fillCircle(gr,pTrail[i],3,pp);
					}		
					
					for (var i=0;i<trail.length;i++){ 
						fillCircle(gr,trail[i],3,fp);
					}	
					
					fillCircle(gr,pos,5,cp);
					
					
					
				}
				setInterval(function(){updateMap(null,null,null,null)},33);
				(function update(){
					$.post("/battery")
						.done(function(data){
							$("#battery").val(data);
						}).always(function(){
							setTimeout(update,10000);
						});
				})();
				$("form [name=do]").click(function(e){
					e.preventDefault();
					$.post("/"+$(this).val());
				});
				$("form [name=go]").click(function(e){
					e.preventDefault();
					$.post("/"+$(this).val())
						.done(function(data){
							$("#photo").attr("alt",data.path).attr("src",data.path);
							$("#photo-link").attr("href",data.path);
						});
				});
				$(document)
					.on("connected",function(e,connected){
						$("body").removeClass("connected disconnected").addClass((connected?"":"dis")+"connected");
						$("input,button[name]").prop("disabled",!connected);
					}).trigger("connected",false);
				var params="";
				(function subscribe(){
					$.ajax({
						url:"/subscribe"+params,
						type:"POST",
						timeout:30000,
						dataType:"json",
					}).fail(function(e){
						if(e.status!=0){
							setTimeout(subscribe,1000);
							return;
						}
						$(document).trigger("connected",false);
						(function reconnect(){
							$.ajax({
								url:"/subscribe",
								type:"POST",
								timeout:10000,//should be immediate
								dataType:"json",
							}).success(function(){
								$(document).trigger("connected",true);
								subscribe();
							}).fail(function(){
								setTimeout(reconnect,1000);
							});
						})();
					}).done(function(data){
						if(!params){//first one; we're done loading the main ui
							$.post("/history?key=photo&t="+data.t)
								.done(function(photos){
									console.log("photos",photos);
								});
						}
						params="?t="+data.t;
						for(var a=data.deltas,i=0;i<a.length;++i){
							console.log("%o: %o at %o",a[i][0],a[i][1],a[i][2]);
							var e=$.Event(a[i][0]);
							e.timeStamp=a[i][2]*1000;
							$(document).trigger(e,a[i][1]);
						}
						subscribe();
					});
				})();
			});
		</script>
	</body>
</html>
